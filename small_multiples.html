<!DOCTYPE html>

<!--
Adam Rule
02.16.2015

Webpage showing screenshots

Helpful Websites
http://stackoverflow.com/questions/13595113/html-javascript-iterate-through-all-elements-of-local-server-side-folder
http://stackoverflow.com/questions/20030162/getting-data-attribute-for-onclick-event-for-an-html-element
-->

<head>
    <title>Small Multiples</title>
    <meta charset="utf-8">

    <link rel="stylesheet" href="//code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css">
    <link rel="stylesheet" type="text/css" href="style.css">

    <script src="//code.jquery.com/jquery-1.9.1.js"></script>
    <script src="//code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>

</head>

<body onload="callForImages()">

    <div id="header">
        <h1>Activity Visualizer</h1>
        <div class="viewSelect">
            <hr>
                <div id="myForm">
                    <input type="radio" value="dayview" name="radio" id="radio1"><label for="radio1">Day</label>
                    <input type="radio" value="weekview" name="radio" id="radio2"><label for="radio2">Week</label>
                    <input type="radio" value="small_multiples" name="radio" id="radio3" checked="checked"><label for="radio3">Small multiples</label>
                </div>
            <hr>
        </div>

        <div class="slider-block">
            <p id='sizeText'>Thumbnail Size: 100 x 100</p>
            <div id='windowSize'></div>
        </div>

        <div class="slider-block">
            <p id='numImageText'># of images: 20</p>
            <div id='numOfImages'></div>
        </div>

		<div id="myForm" style="float: right;">
		    <input type="radio" value="dayview" name="radio" disabled="disabled"><label for="radio1">Day View</label>
		    <input type="radio" value="weekview" name="radio"><label for="radio2">Week View</label>
		    <input type="radio" value="small_multiples" name="radio" checked="checked"><label for="radio3">Small multiples</label>
		</div>

        <div id="aspectForm">
            <input type="radio" value="aspect11" name="radio" id="aspect11" checked="checked"><label for="aspect11">1:1</label>
            <input type="radio" value="aspect1610" name="radio" id="aspect1610"><label for="aspect1610">16:10</label>
        </div>

    </div>

    <div id="images"></div>

    <!-- Main script to display images -->
    <script language="javascript" type="text/javascript">

        var img_data = []

        // starting snippet image size
        var imgW = 100;

        var tooltip = d3.select("body")
            .append("div")
            .attr("id", "tooltip")

        tooltip.append('p')
            .text("Hello")
            .attr("id","tooltip_text")

        tooltip.append("img")
                .attr("src", "benchmark.png")
                .attr("id", "tooltip_image");

        var multiples = d3.select('#images').selectAll('.clickDiv')
            .data([]);

        //Makes an asynchronous request, loading the getimages.php file
        function callForImages() {

            //Create the request object
            var httpReq = (window.XMLHttpRequest)?new XMLHttpRequest():new ActiveXObject("Microsoft.XMLHTTP");

            //When it loads,
            httpReq.onload = function() {

                //Convert the result back into JSON
                var result = JSON.parse(httpReq.responseText);
                for(var i = 0; i < result.length; i++){
                    var filename_elements = result[i].split("_");
                    var x = filename_elements[1];
                    var y = filename_elements[2].split(".")[0];
                    img_data.push([result[i], x, y]);
                }

                //Show the images
                loadImages(img_data);
            }

            //Request the page
            try {
                httpReq.open("GET", "small_multiples.php", true);
                httpReq.send(null);
            } catch(e) {
                console.log(e);
            }
        }

        //Generates the images and sticks them in the container
        function loadImages(images) {

            // only grab 20 images to start
            var reduced_images = [];
            var jump_by = parseInt(images.length/20)
            for(var i = 0; i < images.length; i=i+jump_by) {
                    reduced_images.push(images[i]);
            }

            // add images to page in a div used for cropping
            d3.select('#images').selectAll('div')
                .data(reduced_images)
                .enter().append('div')
                .attr('class', 'clickDiv')
                .append('img')
                    .attr('class', 'clickImg')
                    .attr('src', function(d){return d[0]})
                    .on("mouseover", function(){
                        tooltip.style("visibility", "visible")
                        var imgsrc = this.getAttribute("src");
                        d3.select("#tooltip_image").attr("src", function(){ return imgsrc});
                        imgsrc = imgsrc.split("/").pop()
                        d3.select("#tooltip_text").text( function(){ return imgsrc.substring(2,4) + "/" + imgsrc.substring(4,6) + "/" + imgsrc.substring(0,2) + " - " + imgsrc.substring(7,9) + ":" + imgsrc.substring(9,11) });
                        var rect = this.parentNode.getBoundingClientRect();
                        tooltip.style("top", (rect.bottom + document.body.scrollTop + 10)+"px").style("left",(rect.left)+"px");
                    })
                    .on("mouseout", function(){return tooltip.style("visibility", "hidden");});

            d3.selectAll('.clickImg')
                .style('top', function(d){return -( this.clientHeight - d[2]) + imgW/2 + 'px'})
                .style('left', function(d){return  -d[1] + imgW/2 + 'px'})


            // resize and reposition images on change of image size
            $("#windowSize").slider({max:800},{min:50},{value:100},{slide: function( event, ui ) {
                d3.selectAll('.clickDiv')
                    .style('height', function(){return ui.value+'px'})
                    .style('width', function(){
                        if ($('input[name=radio]:checked', '#aspectForm').val() == "aspect1610"){
                            return Math.round(ui.value*1.6)+'px';
                        }
                        else { return ui.value+'px'; }
                        })
                    .selectAll('.clickImg')
                        .style('top', function(d){return -(this.clientHeight - d[2]) + ui.value/2 + 'px'})
                        .style('left', function(d){return  -d[1] + ui.value/2 + 'px'});
                  
                    if ($('input[name=radio]:checked', '#aspectForm').val() == "aspect1610"){
                           imgW = Math.round(ui.value*1.6);
                        }
                        else { imgW = ui.value; }
                    imgH = ui.value;

                    document.getElementById('sizeText').innerHTML = 'Thumbnail Size: ' + ui.value;
                        imgW = ui.value;
            }});

            // get new set of images when slider for # of images changes
            $("#numOfImages").slider({max:200},{min:10},{step:5},{value:20},{slide: function( event, ui ) {
                var reduced_images = [];
                var jump_by = parseInt(img_data.length/ui.value)
                for(var i = 0; i < img_data.length; i=i+jump_by) {
                        reduced_images.push(img_data[i]);
                }

                multipleDivs = d3.select('#images').selectAll('.clickDiv')
                    .data([])
                    .exit().remove();

                multiples = d3.select('#images').selectAll('img')
                    .data(reduced_images)
                    .enter().append('div')
                    .attr('class', 'clickDiv')
                    .attr('width', imgW)
                    .attr('height', imgW)
                    .append('img')
                        .attr('class', 'clickImg')
                        .attr('src', function(d){return d[0]})
                        .on("mouseover", function(){
                            tooltip.style("visibility", "visible")
                            var imgsrc = this.getAttribute("src")
                            d3.select("#tooltip_image").attr("src", function(){ return imgsrc})
                            imgsrc = imgsrc.split("/").pop()
                            d3.select("#tooltip_text").text( function(){ return imgsrc.substring(2,4) + "/" + imgsrc.substring(4,6) + "/" + imgsrc.substring(0,2) + " - " + imgsrc.substring(7,9) + ":" + imgsrc.substring(9,11) });
                            var rect = this.parentNode.getBoundingClientRect();
                            tooltip.style("top", (rect.bottom + document.body.scrollTop + 10)+"px").style("left",(rect.left)+"px");
                        })
                        .on("mouseout", function(){return tooltip.style("visibility", "hidden");});

                multiples
                    .style('top', function(d){return -(this.clientHeight - d[2]) + imgW/2 + 'px'})
                    .style('left', function(d){return -d[1] + imgW/2 + 'px'});

                document.getElementById('numImageText').innerHTML = '# of images: ' + ui.value;
            }});

            // Go to the index page if the page selection changes
			$('#myForm input').on('change', function() {
			        if ($('input[name=radio]:checked', '#myForm').val() == "dayview"){
			            window.location.href = "index.html";
			        }
			        if ($('input[name=radio]:checked', '#myForm').val() == "weekview"){
			            window.location.href = "index.html";
			        }
			    });

        }

    </script>

</body>

</html>
